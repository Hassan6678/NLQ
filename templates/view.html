<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat CPG - NLQ System</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f8f9fb;
      color: #333;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #f1f3f7;
      border-right: 1px solid #ddd;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    
    .sidebar h3 {
      font-size: 14px;
      margin: 0 0 15px 0;
      color: #555;
      display: flex;
      align-items: center;
    }
    
    .sidebar h3::before {
      content: "üìù";
      margin-right: 8px;
    }

    .control-section {
      margin-bottom: 25px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .control-section h4 {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-active {
      background: #28a745;
    }

    .status-inactive {
      background: #dc3545;
    }

    .status-loading {
      background: #ffc107;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .history-item {
      padding: 8px 12px;
      margin: 5px 0;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    .history-item:hover {
      background: #f8f9fa;
      border-color: #007bff;
    }

    .history-item .query-text {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .history-item .timestamp {
      font-size: 10px;
      color: #666;
    }

    /* Main Chat Area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
    }
    
    .main h1 {
      display: flex;
      align-items: center;
      font-size: 28px;
      margin: 0 0 15px 0;
    }
    
    .main h1::before {
      content: "üí¨";
      margin-right: 10px;
      font-size: 28px;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding-right: 10px;
    }

    .message {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 10px;
      max-width: 80%;
    }

    .message.user {
      background: #007bff;
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.assistant {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #e9ecef;
    }

    .message.processing {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #e9ecef;
    }

    .message-content {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message.user .avatar {
      background: #28a745;
    }

    .text {
      flex: 1;
      word-wrap: break-word;
    }

    .processing-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #6c757d;
    }

    .loading {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .query-result {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .query-result h4 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 16px;
    }

    .sql-code {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .result-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0 8px 0;
    }

    .icon-btn {
      border: 1px solid #e0e0e0;
      background: #ffffff;
      color: #333;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .icon-btn:hover { 
      background: #f3f4f6; 
    }

    .summary-text {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 12px;
      margin: 15px 0;
      font-style: italic;
    }

    .metrics {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
      text-align: center;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .chat-input {
      margin-top: auto;
      display: flex;
      border-top: 1px solid #ddd;
      padding: 20px 0;
      background: transparent;
    }
    
    .chat-input input {
      flex: 1;
      border: 2px solid #e0e0e0;
      padding: 15px;
      font-size: 14px;
      outline: none;
      border-radius: 8px;
      background: white;
      transition: border-color 0.2s ease;
    }
    
    .chat-input input:focus {
      border-color: #007bff;
    }
    
    .chat-input button {
      background: #007bff;
      border: none;
      color: white;
      padding: 15px 25px;
      margin-left: 15px;
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    
    .chat-input button:hover {
      background: #0056b3;
    }

    .chat-input button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 9999;
    }
    .toast {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-left: 4px solid #007bff;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      animation: fadeIn 0.2s ease;
    }
    .toast.success { border-left-color: #28a745; }
    .toast.error { border-left-color: #dc3545; }
    .toast.info { border-left-color: #0d6efd; }
    .toast .close {
      float: right;
      border: none;
      background: transparent;
      color: #666;
      cursor: pointer;
      font-size: 14px;
    }
    @keyframes fadeIn { from {opacity: 0; transform: translate(-50%, -6px);} to {opacity: 1; transform: translate(-50%, 0);} }

    /* Scrollable history container */
    #historyContainer { max-height: 320px; overflow-y: auto; }
    
    /* Chat container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      min-height: 400px;
      max-height: calc(100vh - 200px);
    }
    
    .message {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .message.user {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      margin-left: 20%;
      color: #222; /* Ensure readable text color on user message bubbles */
    }
    
    .message.assistant {
      background: #f3e5f5;
      border-left: 4px solid #9c27b0;
      margin-right: 20%;
    }
    
    .message.system {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      text-align: center;
      font-style: italic;
    }
    
    .message.processing {
      background: #f3e5f5;
      border-left: 4px solid #9c27b0;
      margin-right: 20%;
    }
    
    .message-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .message.assistant .avatar,
    .message.processing .avatar {
      background: #9c27b0;
    }
    
    .message.user .avatar {
      background: #2196f3;
    }
    
    .text {
      flex: 1;
      line-height: 1.5;
    }
    
    .processing-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .loading {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #9c27b0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="control-section">
      <h4>System Controls</h4>
      <button id="initBtn" class="btn btn-primary">
        <span class="status-indicator status-inactive"></span>
        Initialize System
      </button>
      <button id="loadDatasetBtn" class="btn btn-success" disabled>
        Load Dataset
      </button>
  <button id="refreshTableBtn" class="btn btn-primary" disabled>Refresh Table</button>
  <button id="deleteDbBtn" class="btn btn-warning" disabled>Delete DB</button>
    </div>

    <div class="control-section">
      <h4>System Status</h4>
      <div id="systemStatus">
        <div>System: <span class="status-indicator status-inactive"></span>Inactive</div>
        <div>Dataset: <span class="status-indicator status-inactive"></span>Not Loaded</div>
      </div>
    </div>

    <div class="control-section">
      <h4>Recent Queries</h4>
      <div id="historyContainer">
        <div class="message system">No queries yet</div>
      </div>
      <button id="clearHistoryBtn" class="btn btn-warning" disabled>Clear History</button>
    </div>
  </div>

  <!-- Main Area -->
  <div class="main">
    <h1>Chat CPG - NLQ System</h1>
    
    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
      <!-- Messages will be added here dynamically -->
    </div>
    
    <!-- Input -->
    <div class="chat-input">
      <input type="text" id="queryInput" placeholder="Ask a question about your data (e.g., 'Show top 5 territories by sales in December')" disabled>
      <button id="sendBtn" disabled>
        <span class="loading hidden"></span>
        Send
      </button>
    </div>
  </div>

  <script>
    class NLQChat {
      constructor() {
        this.systemInitialized = false;
        this.datasetLoaded = false;
        this.isProcessing = false;
        this.resultCounter = 0;
        this.initEventListeners();
        this.updateUI();
        // Show welcome toast that auto dismisses
        this.showToast("Welcome! I'm your NLQ assistant. Please initialize the system and load a dataset to get started.", 'info', 4500);
      }

      initEventListeners() {
        document.getElementById('initBtn').addEventListener('click', () => this.initializeSystem());
        document.getElementById('loadDatasetBtn').addEventListener('click', () => this.loadDataset());
  document.getElementById('refreshTableBtn').addEventListener('click', () => this.refreshTable());
  document.getElementById('deleteDbBtn').addEventListener('click', () => this.deleteDb());
        document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());
        document.getElementById('sendBtn').addEventListener('click', () => this.sendQuery());
        document.getElementById('queryInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !this.isProcessing) {
            this.sendQuery();
          }
        });
      }

      async initializeSystem() {
        const btn = document.getElementById('initBtn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="loading"></span>Initializing...';
        btn.disabled = true;

        try {
          const response = await fetch('/api/initialize', { method: 'POST' });
          const data = await response.json();
          
          if (data.success) {
            this.systemInitialized = true;
            this.showToast('System initialized successfully! You can now load a dataset.', 'success', 3500);
            this.updateUI();
          } else {
            this.showToast(`Initialization failed: ${data.message}`, 'error', 4500);
          }
        } catch (error) {
          this.showToast(`Error: ${error.message}`, 'error', 4500);
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      async loadDataset() {
        const btn = document.getElementById('loadDatasetBtn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="loading"></span>Loading...';
        btn.disabled = true;

        try {
          const response = await fetch('/api/load_dataset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              dataset_path: 'data/llm_dataset_v11.gz',
              table_name: 'sales_data'
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            this.datasetLoaded = true;
            this.showToast(`Dataset loaded successfully! ${data.message}`, 'success', 3500);
            this.updateUI();
          } else {
            this.showToast(`Failed to load dataset: ${data.message}`, 'error', 4500);
          }
        } catch (error) {
          this.showToast(`Error: ${error.message}`, 'error', 4500);
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      async refreshTable() {
        if (!this.datasetLoaded) return;
        const btn = document.getElementById('refreshTableBtn');
        const original = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span>Refreshing...';
        btn.disabled = true;
        try {
          const response = await fetch('/api/refresh_table', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dataset_path:'data/llm_dataset_v11.gz', table_name:'sales_data'})});
          const data = await response.json();
          if (data.success) {
            this.showToast('Table refreshed', 'success', 3000);
          } else {
            this.showToast('Refresh failed: '+data.message, 'error', 4000);
          }
        } catch (e) {
          this.showToast('Refresh error: '+e.message, 'error', 4000);
        } finally {
          btn.innerHTML = original;
          btn.disabled = false;
        }
      }

      async deleteDb() {
        const btn = document.getElementById('deleteDbBtn');
        const original = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span>Deleting...';
        btn.disabled = true;
        try {
          const response = await fetch('/api/delete_db', {method:'POST'});
            const data = await response.json();
            if (data.success) {
              this.showToast('Database deleted. Reload dataset to rebuild.', 'warning', 4000);
              this.datasetLoaded = false;
              this.updateUI();
            } else {
              this.showToast('Delete failed: '+data.message, 'error', 4000);
            }
        } catch (e) {
          this.showToast('Delete error: '+e.message, 'error', 4000);
        } finally {
          btn.innerHTML = original;
          btn.disabled = false;
        }
      }

      async sendQuery() {
        const input = document.getElementById('queryInput');
        const query = input.value.trim();
        
        if (!query || this.isProcessing) return;

        this.isProcessing = true;
        this.addMessage(query, 'user');
        input.value = '';
        
        // Add processing indicator
        const processingMsg = this.addMessage('', 'processing');
        
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.innerHTML = '<span class="loading"></span>Processing...';
        sendBtn.disabled = true;

        try {
          console.log('Sending query:', query);
          const startTime = Date.now();
          
          const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`Query response received in ${responseTime}ms`);
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Query result:', data);
          
          // Remove processing message
          if (processingMsg && processingMsg.parentNode) {
            processingMsg.parentNode.removeChild(processingMsg);
          }
          
          if (data.success) {
            this.displayQueryResult(data);
            this.loadHistory();
          } else {
            this.addMessage(`Query failed: ${data.message}`, 'assistant');
          }
        } catch (error) {
          console.error('Query error:', error);
          
          // Remove processing message
          if (processingMsg && processingMsg.parentNode) {
            processingMsg.parentNode.removeChild(processingMsg);
          }
          
          this.addMessage(`Error: ${error.message}`, 'assistant');
        } finally {
          this.isProcessing = false;
          sendBtn.innerHTML = 'Send';
          sendBtn.disabled = false;
        }
      }

      displayQueryResult(data) {
        const container = document.createElement('div');
        container.className = 'query-result';
        const sectionId = `sql-${++this.resultCounter}`;
        
        container.innerHTML = `
          <h4>üìä Query Results</h4>
          <div class="metrics">
            <div class="metric">
              <div class="metric-value">${data.row_count}</div>
              <div class="metric-label">Rows</div>
            </div>
            <div class="metric">
              <div class="metric-value">${data.execution_time.toFixed(3)}s</div>
              <div class="metric-label">Execution</div>
            </div>
            <div class="metric">
              <div class="metric-value">${data.total_time.toFixed(3)}s</div>
              <div class="metric-label">Total Time</div>
            </div>
          </div>
          <div class="result-actions">
            <button class="icon-btn" onclick="chat.toggleSection('${sectionId}')">üîç Show SQL</button>
            <button class="icon-btn" onclick="chat.copySQL('${sectionId}')">‚ßâ Copy SQL</button>
          </div>
          <div id="${sectionId}" class="sql-code hidden">${data.sql}</div>
          
          ${data.summary ? `<h5>üìù Summary:</h5><div class="summary-text">${data.summary}</div>` : ''}
          
          ${data.row_count > 0 ? `<h5>üìã Data (${data.row_count} rows):</h5><div class="sql-code">${JSON.stringify(data.data.slice(0, 5), null, 2)}${data.row_count > 5 ? '\n... and ' + (data.row_count - 5) + ' more rows' : ''}</div>` : '<div class="message system">No data returned</div>'}
        `;
        
        document.getElementById('chatContainer').appendChild(container);
        this.scrollToBottom();
      }

      async loadHistory() {
        try {
          const response = await fetch('/api/history');
          const data = await response.json();
          
          if (data.success) {
            this.updateHistoryUI(data.history);
          }
        } catch (error) {
          console.error('Failed to load history:', error);
        }
      }

      updateHistoryUI(history) {
        const container = document.getElementById('historyContainer');
        if (!history || history.length === 0) {
          container.innerHTML = '<div class="message system">No queries yet</div>';
          return;
        }

        // Group by date (Today, Yesterday, Previous 7 Days)
        const groups = { today: [], yesterday: [], week: [] };
        const now = new Date();
        const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(midnight.getTime() - 24*60*60*1000);
        const weekAgo = new Date(midnight.getTime() - 7*24*60*60*1000);

        history.forEach(item => {
          const ts = new Date(item.timestamp.replace(' ', 'T'));
          if (ts >= midnight) groups.today.push(item);
          else if (ts >= yesterday) groups.yesterday.push(item);
          else if (ts >= weekAgo) groups.week.push(item);
        });

        function renderGroup(items, label) {
          if (!items || items.length === 0) return '';
          const cards = items.slice(-20).reverse().map(it => `
            <div class="history-item" onclick="chat.loadHistoryItem(${it.id})" title="${it.query}">
              <div class="query-text">${it.query.length > 60 ? it.query.substring(0, 60) + '...' : it.query}</div>
              <div class="timestamp">${it.timestamp} (${it.row_count} rows)</div>
            </div>
          `).join('');
          return `<h4>${label}</h4>${cards}`;
        }

        container.innerHTML = `
          ${renderGroup(groups.today, 'Today')}
          ${renderGroup(groups.yesterday, 'Yesterday')}
          ${renderGroup(groups.week, 'Previous 7 Days')}
        `;
      }

      async loadHistoryItem(queryId) {
        try {
          const response = await fetch(`/api/history/${queryId}`);
          const data = await response.json();
          
          if (data.success) {
            this.addMessage(`Previous query: ${data.item.query}`, 'system');
            if (data.item.summary) {
              this.addMessage(`Summary: ${data.item.summary}`, 'system');
            }
          }
        } catch (error) {
          console.error('Failed to load history item:', error);
        }
      }

      async clearHistory() {
        try {
          const response = await fetch('/api/clear_history', { method: 'POST' });
          const data = await response.json();
          
          if (data.success) {
            this.updateHistoryUI([]);
            this.addMessage('History cleared', 'success');
          }
        } catch (error) {
          this.addMessage(`Failed to clear history: ${error.message}`, 'error');
        }
      }

      addMessage(content, type) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        if (type === 'user') {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="avatar">U</div>
              <div class="text">${content}</div>
            </div>
          `;
        } else if (type === 'assistant') {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="avatar">AI</div>
              <div class="text">${content}</div>
            </div>
          `;
        } else if (type === 'processing') {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="avatar">AI</div>
              <div class="text">
                <div class="processing-indicator">
                  <span class="loading"></span>
                  Processing your query...
                </div>
              </div>
            </div>
          `;
        }
        
        container.appendChild(messageDiv);
        this.scrollToBottom();
        return messageDiv;
      }

      toggleSection(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const isHidden = el.classList.contains('hidden');
        el.classList.toggle('hidden');
        // Update preceding button label if present
        const btn = el.parentElement.querySelector('.icon-btn');
        if (btn) btn.textContent = isHidden ? 'üîç Hide SQL' : 'üîç Show SQL';
      }

      copySQL(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const text = el.innerText || el.textContent;
        navigator.clipboard.writeText(text).then(() => {
          this.showToast('SQL copied to clipboard', 'info', 2000);
        }).catch(() => {
          this.showToast('Failed to copy', 'error', 2000);
        });
      }

      showToast(message, type = 'info', timeout = 4000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<button class="close" onclick="this.parentElement.remove()">√ó</button>${message}`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.transition = 'opacity 0.3s ease';
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, timeout);
      }

      updateUI() {
        const initBtn = document.getElementById('initBtn');
        const loadDatasetBtn = document.getElementById('loadDatasetBtn');
  const refreshBtn = document.getElementById('refreshTableBtn');
  const deleteBtn = document.getElementById('deleteDbBtn');
        const queryInput = document.getElementById('queryInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        
        // Update system status
        const systemStatus = document.getElementById('systemStatus');
        systemStatus.innerHTML = `
          <div>System: <span class="status-indicator ${this.systemInitialized ? 'status-active' : 'status-inactive'}"></span>${this.systemInitialized ? 'Active' : 'Inactive'}</div>
          <div>Dataset: <span class="status-indicator ${this.datasetLoaded ? 'status-active' : 'status-inactive'}"></span>${this.datasetLoaded ? 'Loaded' : 'Not Loaded'}</div>
        `;
        
        // Update button states
        if (this.systemInitialized) {
          initBtn.innerHTML = '<span class="status-indicator status-active"></span>System Ready';
          initBtn.disabled = true;
          loadDatasetBtn.disabled = false;
          deleteBtn.disabled = false; // allow delete before load to clear old file
        }
        
        if (this.datasetLoaded) {
          loadDatasetBtn.innerHTML = 'Dataset Loaded';
          loadDatasetBtn.disabled = true;
          refreshBtn.disabled = false;
          deleteBtn.disabled = false;
          queryInput.disabled = false;
          sendBtn.disabled = false;
          clearHistoryBtn.disabled = false;
        } else {
          refreshBtn.disabled = true;
        }
      }

      scrollToBottom() {
        const container = document.getElementById('chatContainer');
        container.scrollTop = container.scrollHeight;
      }
    }

    // Initialize the chat when page loads
    let chat;
    document.addEventListener('DOMContentLoaded', () => {
      chat = new NLQChat();
    });
  </script>
</body>
</html>
